---

- name: "Check out version {{ component.version }} of HACS repo {{ component.repo }}"
  git:
    repo: "{{ component.repo }}"
    depth: 1
    version: "{{ component.version }}"
    dest: /tmp/hacs

- name: "Copy {{ component.name }} to {{ homeassistant_component_directory }}"
  block:
    - copy:
        remote_src: yes
        src: "/tmp/hacs/{{ component.name }}"
        dest: "{{ homeassistant_component_directory }}/{{ component.name }}"
      when:
        - '{{ "/tmp/hacs/"~component.name is directory }}'
    - copy:
        remote_src: yes
        src: "/tmp/hacs/custom_components/{{ component.name }}"
        dest: "{{ homeassistant_component_directory }}/{{ component.name }}/"
      when:
        - '{{ "/tmp/hacs/custom_components/"~component.name is directory }}'

- name: Check if component requires zeroconf
  block:
    - lineinfile:
        name: "{{ homeassistant_component_directory }}/{{ component.name }}/manifest.json"
        regexp: '^ *zeroconf.*$'
        state: present
      check_mode: yes
      register: requires_zero_conf

    - set_fact:
        homeassistant_enable_zeroconf: yes
      when:
        - (requires_zero_conf is changed) or (requires_zero_conf is failed)

- name: Check if component requires ssdp
  block:
    - lineinfile:
        name: "{{ homeassistant_component_directory }}/{{ component.name }}/manifest.json"
        regexp: '^ *ssdp.*$'
        state: present
      check_mode: yes
      register: requires_ssdp

    - set_fact:
        homeassistant_enable_ssdp: yes
      when:
        - (requires_ssdp is changed) or (requires_ssdp is failed)

- name: Clean up
  file:
    path: /tmp/hacs
    state: absent


